{% extends 'base.html' %}
{% block title %}Chick Pay - ì†¡ê¸ˆí•˜ê¸°{% endblock %}

{% block content %}
<main class="container mx-auto px-4 py-10 flex-grow">
    <div class="max-w-2xl mx-auto">
        <h2 class="text-3xl font-bold text-chick-brown mb-8 text-center">ì†¡ê¸ˆí•˜ê¸°</h2>

        <div class="bg-white rounded-3xl shadow-lg p-8 border-3 border-chick-yellow">
            <form id="transfer-form">
                <div class="mb-6">
                    <label for="from-account" class="block mb-2 font-semibold text-gray-600">ì¶œê¸ˆ ê³„ì¢Œ</label>
                    <select id="from-account" required
                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
                        <option value="" disabled selected>ì¶œê¸ˆ ê³„ì¢Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="kb">KBêµ­ë¯¼ì€í–‰ 123-456-789012 (ì”ì•¡: â‚©1,250,000)</option>
                        <option value="shinhan">ì‹ í•œì€í–‰ 987-654-321098 (ì”ì•¡: â‚©3,750,000)</option>
                        <option value="hana">í•˜ë‚˜ì€í–‰ 111-222-333444 (ì”ì•¡: â‚©850,000)</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label for="to-bank" class="block mb-2 font-semibold text-gray-600">ì…ê¸ˆ ì€í–‰</label>
                    <select id="to-bank" required
                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
                        <option value="" disabled selected>ì…ê¸ˆ ì€í–‰ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="kb">KBêµ­ë¯¼ì€í–‰</option>
                        <option value="shinhan">ì‹ í•œì€í–‰</option>
                        <option value="woori">ìš°ë¦¬ì€í–‰</option>
                        <option value="hana">í•˜ë‚˜ì€í–‰</option>
                        <option value="nh">ë†í˜‘ì€í–‰</option>
                        <option value="ibk">ê¸°ì—…ì€í–‰</option>
                        <option value="kakao">ì¹´ì¹´ì˜¤ë±…í¬</option>
                        <option value="toss">í† ìŠ¤ë±…í¬</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label for="to-account" class="block mb-2 font-semibold text-gray-600">ì…ê¸ˆ ê³„ì¢Œë²ˆí˜¸</label>
                    <input type="text" id="to-account" placeholder="ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (- ì—†ì´)" required
                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
                </div>

                <div class="mb-6">
                    <label for="to-name" class="block mb-2 font-semibold text-gray-600">ë°›ëŠ” ë¶„ ì´ë¦„</label>
                    <input type="text" id="to-name" placeholder="ë°›ëŠ” ë¶„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required
                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
                </div>

                <div class="mb-6">
                    <label for="amount" class="block mb-2 font-semibold text-gray-600">ì†¡ê¸ˆ ê¸ˆì•¡</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500">â‚©</span>
                        <input type="number" id="amount" placeholder="0" required min="1000" step="1000"
                            class="w-full p-3 pl-8 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
                    </div>
                </div>

                <div class="mb-8">
                    <label for="memo" class="block mb-2 font-semibold text-gray-600">ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="memo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-chick-orange focus:outline-none transition">
                </div>

                <div class="flex items-center mb-6">
                    <input type="checkbox" id="save-recipient" class="mr-2">
                    <label for="save-recipient" class="text-sm text-gray-600">ìì£¼ ì“°ëŠ” ê³„ì¢Œë¡œ ì €ì¥</label>
                </div>

                <button type="submit"
                    class="w-full bg-chick-yellow text-chick-brown font-bold py-4 px-6 rounded-xl shadow-md hover:bg-chick-orange transition transform hover:-translate-y-0.5 active:translate-y-0">
                    ì†¡ê¸ˆí•˜ê¸° ğŸ¥
                </button>
            </form>
        </div>

        <div class="mt-8">
            <h3 class="text-xl font-bold text-chick-brown mb-4">ìì£¼ ì“°ëŠ” ê³„ì¢Œ</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-xl p-4 shadow-md border border-chick-yellow cursor-pointer hover:bg-chick-light transition"
                    onclick="fillRecipient('ë°•ì˜í¬', 'ì‹ í•œì€í–‰', '110223344556')">
                    <p class="font-bold">ë°•ì˜í¬</p>
                    <p class="text-sm text-gray-600">ì‹ í•œì€í–‰ 110-223-344556</p>
                </div>

                <div class="bg-white rounded-xl p-4 shadow-md border border-chick-yellow cursor-pointer hover:bg-chick-light transition"
                    onclick="fillRecipient('ì´ì² ìˆ˜', 'KBêµ­ë¯¼ì€í–‰', '123456789012')">
                    <p class="font-bold">ì´ì² ìˆ˜</p>
                    <p class="text-sm text-gray-600">KBêµ­ë¯¼ì€í–‰ 123-456-789012</p>
                </div>

                <div class="bg-white rounded-xl p-4 shadow-md border border-chick-yellow cursor-pointer hover:bg-chick-light transition"
                    onclick="fillRecipient('ê¹€ë¯¼ì§€', 'ì¹´ì¹´ì˜¤ë±…í¬', '3333044455555')">
                    <p class="font-bold">ê¹€ë¯¼ì§€</p>
                    <p class="text-sm text-gray-600">ì¹´ì¹´ì˜¤ë±…í¬ 3333-04-4455555</p>
                </div>

                <div class="bg-white rounded-xl p-4 shadow-md border border-chick-yellow cursor-pointer hover:bg-chick-light transition"
                    onclick="fillRecipient('ìµœì¤€í˜¸', 'ìš°ë¦¬ì€í–‰', '1002757788899')">
                    <p class="font-bold">ìµœì¤€í˜¸</p>
                    <p class="text-sm text-gray-600">ìš°ë¦¬ì€í–‰ 1002-757-788899</p>
                </div>
            </div>
        </div>
    </div>
</main>


<script>
    // ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€
    const menuButton = document.querySelector('button');
    const nav = document.querySelector('nav');

    menuButton.addEventListener('click', function () {
        if (nav.classList.contains('hidden')) {
            nav.classList.remove('hidden');
            nav.classList.add('flex', 'flex-col', 'absolute', 'top-16', 'right-4', 'bg-white', 'p-4', 'rounded-xl', 'shadow-lg', 'z-50');
        } else {
            nav.classList.add('hidden');
            nav.classList.remove('flex', 'flex-col', 'absolute', 'top-16', 'right-4', 'bg-white', 'p-4', 'rounded-xl', 'shadow-lg', 'z-50');
        }
    });

    // ê³„ì¢Œë²ˆí˜¸ ìˆ«ìë§Œ ì…ë ¥
    document.getElementById('to-account').addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });

    // ìì£¼ ì“°ëŠ” ê³„ì¢Œ ì„ íƒ
    function fillRecipient(name, bank, account) {
        document.getElementById('to-name').value = name;

        const bankSelect = document.getElementById('to-bank');
        for (let i = 0; i < bankSelect.options.length; i++) {
            if (bankSelect.options[i].text === bank) {
                bankSelect.selectedIndex = i;
                break;
            }
        }

        document.getElementById('to-account').value = account.replace(/\D/g, '');
    }

    // âœ… ì†¡ê¸ˆ API í˜¸ì¶œ
    document.getElementById('transfer-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const fromAccount = document.getElementById('from-account').value;
        const toAccount = document.getElementById('to-account').value;
        const amount = document.getElementById('amount').value;

        const button = this.querySelector('button');
        button.textContent = 'ì²˜ë¦¬ ì¤‘...';
        button.disabled = true;

        try {
            const res = await fetch('/transfer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    from_id: fromAccount,
                    to_id: toAccount,
                    amount: amount
                })
            });

            const data = await res.json();

            if (res.ok) {
                window.location.href = '/transfer/complete/';
            } else {
                alert('ì†¡ê¸ˆ ì‹¤íŒ¨: ' + data.error);
                button.textContent = 'ì†¡ê¸ˆí•˜ê¸° ğŸ¥';
                button.disabled = false;
            }
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            button.textContent = 'ì†¡ê¸ˆí•˜ê¸° ğŸ¥';
            button.disabled = false;
        }
    });

    // âœ… CSRF í† í° ê°€ì ¸ì˜¤ê¸° (Djangoìš©)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}